<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BVV-GB ǀ CRM Elixir</title>
  <style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee; --acc2:#60a5fa; --border:#1f2937; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,#0b1220, #0f172a 120%); color:var(--text); overflow: hidden !important;}
  .wrap{max-width:100%;padding:0 16px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding-top: 10px;}
  .title{font-size:20px;font-weight:700;letter-spacing:.2px}
  .badge{font-size:12px;color:#0b1220;background:linear-gradient(90deg,var(--acc),var(--acc2));padding:6px 10px;border-radius:999px;font-weight:700}

  /* Inputs */
  input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="color"]),
  select, textarea{
    background:#0b1220;border:1px solid var(--border);color:var(--text);
    padding:10px 12px;border-radius:10px;outline:none;width:100%;
  }
  input::placeholder,textarea::placeholder{color:#6b7280}
  .btn{border:1px solid var(--border);background:#0b1220;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;transition:.15s ease;user-select:none}
  .btn:hover{transform:translateY(-1px);border-color:#2c3747}
  .btn.primary{background:linear-gradient(90deg,var(--acc),var(--acc2));color:#0b1220;border:none;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.danger{background:#241114;border-color:#3d1a1a;color:#fca5a5}
  .btn.important{background:#241f11;border-color:#3d301a;color:#fcdea5}
  .btn.validate{background:#112416;border-color:#1c3d1a;color:#c3fca5}
  .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}

  .grid{display:grid;grid-template-columns:1fr auto auto;gap:10px}
  .card{background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:16px;padding:14px}

  /* TABLE + SCROLLBAR */
  .table-container{overflow-x:auto;-webkit-overflow-scrolling:touch}
  /* Scrollbar style */
  /* Firefox (thumb, track) */
  .top-scroll,
  .table-container{
    scrollbar-color: var(--muted) #000; /* thumb noir/gris foncé sur track noir */
    scrollbar-width: thin;      /* optionnel */
  }
  /* WebKit (Chrome, Edge, Safari) */
  .top-scroll::-webkit-scrollbar,
  .table-container::-webkit-scrollbar{
    height: 12px;               /* hauteur de la barre horizontale */
  }
  .top-scroll::-webkit-scrollbar-track,
  .table-container::-webkit-scrollbar-track{
    background: #000;           /* rail noir */
  }
  .top-scroll::-webkit-scrollbar-thumb,
  .table-container::-webkit-scrollbar-thumb{
    background: #222;           /* “pouce” gris très foncé pour contraste */
    border-radius: 999px;
    border: 2px solid #000;     /* liseré noir -> plus propre */
  }

  .table{
    table-layout:fixed;                 /* Respecte les largeurs de colonnes */
    border-collapse:separate;
    border-spacing:0 8px;
    width:max-content;                  /* La table peut dépasser et scroller */
  }
  .table thead th{
    font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;
    letter-spacing:.08em;text-align:left;padding:0 10px 6px;white-space:nowrap
  }
  .table th, .table td{
    padding:12px 10px;
    overflow-wrap:anywhere;             /* le contenu ne force pas l’élargissement */
  }
  .row{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px}
  .row td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
  .row td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

  /* Largeurs par colonne (exemples) */
  .table th:nth-child(2), .table td:nth-child(2){ max-width:250px; font-weight: 700 !important; }        
  .table th:nth-child(3), .table td:nth-child(3){ max-width:100px; }        
  .table th:nth-child(4), .table td:nth-child(4){ max-width:auto; }        
  .table th:nth-child(5), .table td:nth-child(5){ max-width:500px;} .table td:nth-child(5) {color: rgba(255, 255, 255, 0.5) !important;}       
  .table th:nth-child(6), .table td:nth-child(6){ max-width:140px; }        
  .table th:nth-child(7), .table td:nth-child(7){ max-width:200px; }        
  .table th:nth-child(8), .table td:nth-child(8){ max-width:150px; }        
  .table th:nth-child(9), .table td:nth-child(9){ max-width:150px; }        
  .table th:nth-child(10), .table td:nth-child(10){ max-width:150px; }        
  .table th:nth-child(11), .table td:nth-child(11){ max-width:300px; }        

  .muted{color:var(--muted)}
  .actions{display:flex;gap:8px;justify-content:center; align-items: center;}
  .link{color:#93c5fd;text-decoration:none;word-break:break-all}

  dialog{border:none;border-radius:16px;padding:0;max-width:820px;width:96%;background:#0b1220;color:var(--text)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
  .modal-body{padding:16px}
  .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .modal-grid textarea{grid-column:1/-1;height:96px}
  .modal-grid .full{grid-column:1/-1}
  .modal-foot{display:flex;justify-content:flex-end;gap:10px;padding:14px 16px;border-top:1px solid var(--border)}

  .hint{font-size:12px;color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;border:1px solid var(--border);padding:3px 6px;border-radius:6px;background:#0b1220}
  .right{display:flex;align-items:center;gap:10px}

  /* Loader overlay */
  .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999;background:rgba(2,6,23,.55);backdrop-filter:saturate(150%) blur(2px)}
  .loading.show{display:flex}
  .spinner{width:28px;height:28px;border-radius:50%;border:3px solid #64748b;border-top-color:transparent;animation:spin 0.9s linear infinite}
  .loading-box{display:flex;align-items:center;gap:12px;background:#0b1220;border:1px solid #334155;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .loading-msg{font-size:14px;color:var(--text)}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Colonne Actions : grille 2x2 centrée dans la cellule */


  /* Taille/align des boutons pour une grille propre */
  .table td.actions .btn{
    width: 40px;
    height: 40px;
    padding: 0;
    display: inline-grid;
    place-items: center;
    border-radius: 10px;                   /* optionnel, joli */
  }
  /* Visual for favoris (orange) and validate (green) on the whole row.
     Use box-shadow so the layout doesn't jump when highlighting. */
  .row.favoris{ background-color: #241f11; }
  .row.valide{ background-color:#112416; }
  /* If both are present, validation (green) should visually win */
  .row.favoris.valide{ background-color:#112416; }

  /* Button active states */
  .btn.important.active{ background: linear-gradient(90deg,#ffb16a,#fb923c); color:#081218; border-color:#fb923c; }
  .btn.validate.active{ background: linear-gradient(90deg,#1fbf80,#34d399); color:#062012; border-color:#1fbf80; }

  .btn.red{ background:#ef4444; }
  .btn.orange{ background:#fb923c; }
  .btn.green{ background:#10b981; }

  .text-red{ color:#ef4444; opacity: .5;}
  .text-orange{ color:#fb923c; opacity: .5;}
  .text-green{ color:#10b981; opacity: .5;}

  /* favoris state visuals */
  .row.favoris-no{ background:#241114; }
  .row.favoris-call{ background:#241f11; }
</style>
</style>

</head>
<body>
  <div class="wrap">
    <header style="position: sticky; top: 0px; background-color: #0B1220 !important; z-index: 10; height:6vh;">
      <div class="title">BVV-GB ǀ CRM Elixir <span class="badge">Google Sheets Backup</span></div>
      <div class="right">
        <button class="btn" id="btnExport">⇪ Pousser les modifs</button>
        <button class="btn ghost" id="btnExportCsv">⤓ Export CSV</button>
        <button class="btn" id="btnSettings">⚙️ Paramètres</button>
        <button class="btn primary" id="btnAdd">+ Nouveau</button>
      </div>
    </header>

    <div class="card" style="margin-bottom:14px; position: sticky; z-index: 10; border: none; background: none;">
      <div class="grid" style="grid-template-columns: 1fr auto auto auto; height: 4vh;">
        <input id="search" type="text" placeholder="Rechercher (société, nom, mail, téléphone, commentaires)…" />
        <select id="filtreValide">
          <option value="">Tous</option>
          <option value="valide">Prend un pack</option>
          <option value="important">À rappeler</option>
          <option value="favoris">Ne prend pas</option>
        </select>
        <select id="filtreMagazine">
          <option value="">Magazines</option>
          <option value="BVV">BVV</option>
          <option value="GB">GB</option>
        </select>
        <select id="filtreRappel">
          <option value="">Date de rappel</option>
          <option value="en_retard">En retard</option>
          <option value="a_venir">À venir</option>
          <option value="aujourdhui">Aujourd'hui</option>
          <option value="cette_semaine">Cette semaine</option>
        </select>
      </div>
      <!-- <div class="hint" style="margin-top:8px">Astuce : tapez <span class="kbd">@gmail</span> pour filtrer les emails, ou <span class="kbd">tel:</span> pour chercher un numéro exact.</div> -->
    </div>

    <div class="card table-container top-scroll" style="height: 80vh; padding: 0 !important;">
      <table class="table" aria-label="Tableau des contacts">
        <thead style="position: sticky; top: 0; background-color: #161D2A; z-index: 10; line-height: 40px;">
          <tr>
            <th>Actions</th>
            <th>SOCIETE</th>
            <th>Magazine</th>
            <th>DATE DE RAPPEL</th>
            <th>COMMENTAIRES</th>
            <th>TELEPHONE</th>
            <th>MAIL</th>
            <th>NOM</th>
            <th>PRENOM</th>
            <th>POSTE</th>
            <th>ADRESSE</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <dialog id="dlgSettings">
      <form method="dialog" id="frmSettings">
        <div class="modal-head">
          <div style="font-weight:700">Paramètres & intégration Sheets</div>
          <button class="btn ghost" value="cancel" aria-label="Fermer">✕</button>
        </div>
        <div class="modal-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label class="hint">URL Web App (Apps Script) :</label>
              <input id="apiUrl" type="text" placeholder="https://script.google.com/macros/s/XXXXXXXX/exec" />
            </div>
            <div>
              <label class="hint">ID Google Sheet (facultatif) :</label>
              <input id="sheetId" type="text" placeholder="1AbCDef..." />
            </div>
          </div>
          <div class="hint" style="margin-top:8px">
            Laissez vide pour travailler hors-ligne (LocalStorage). Quand vous ajoutez l'URL, les boutons Import/Export communiquent avec votre feuille.
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn" value="cancel">Fermer</button>
          <button class="btn" id="btnImport">↻ Charger depuis Sheets</button>
          <button class="btn primary" value="default">Enregistrer</button>
        </div>
      </form>
    </dialog>



    
  </div>

  <!-- Loader overlay -->
  <div id="loading" class="loading" role="status" aria-live="polite" aria-hidden="true">
    <div class="loading-box">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-msg" id="loadingMsg">Chargement…</div>
    </div>
  </div>

  <!-- Footer counts -->
  <div class="crm-footer" id="crmFooter" style="display: flex; gap: 20px; margin-left: 20px; align-items: center;">
    <div style="display:flex;align-items:center;gap:8px;margin-right:8px;">
      <label class="hint" style="font-size:12px;">Période</label>
      <select id="filtrePeriode">
        <option value="">Tous</option>
        <option value="mois">Mois en cours</option>
        <option value="annee">Année en cours</option>
        <option value="custom">Personnalisée</option>
      </select>
      <div id="filtrePeriodeCustom" style="display:none;align-items:center;gap:6px;margin-left:8px;">
        <label class="hint" style="font-size:12px;">Du</label>
        <input id="filtrePeriodeFrom" type="date" style="padding:6px;border-radius:8px;height:36px;" />
        <label class="hint" style="font-size:12px;">Au</label>
        <input id="filtrePeriodeTo" type="date" style="padding:6px;border-radius:8px;height:36px;" />
      </div>
    </div>
    <div class="item">Appels total : <span class="count" id="cntTotal">0</span></div>
    <div class="item text-red">Refus (Ne prend pas) : <span class="count" id="cntRefus">0</span></div>
    <div class="item text-orange">À rappeler : <span class="count" id="cntRappel">0</span></div>
    <div class="item text-green">Packs vendus : <span class="count" id="cntPacks">0</span></div>
  </div>

  <dialog id="dlg">
    <form method="dialog" id="frm">
      <div class="modal-head">
        <div id="dlgTitle" style="font-weight:700">Nouveau contact</div>
        <button class="btn ghost" value="cancel">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="id" />
        <div class="modal-grid">
          <div>
            <label class="hint">Société</label>
            <input id="societe" type="text" placeholder="Ex: ACME" />
          </div>
          <div>
            <label class="hint">Magazine</label>
            <select id="magazine">
              <option value="">—</option>
              <option value="BVV">BVV</option>
              <option value="GB">GB</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          <div>
            <label class="hint">Date de rappel</label>
            <input id="dateRappel" type="date" />
          </div>
          <div>
            <label class="hint">Téléphone</label>
            <input id="telephone" type="tel" placeholder="06…" />
          </div>
          <div>
            <label class="hint">Mail</label>
            <input id="mail" type="email" placeholder="nom@exemple.com" />
          </div>
          <div>
            <label class="hint">Poste</label>
            <input id="poste" type="text" placeholder="Poste" />
          </div>
          <div>
            <label class="hint">Nom</label>
            <input id="nom" type="text" placeholder="Nom" />
          </div>
          <div>
            <label class="hint">Prénom</label>
            <input id="prenom" type="text" placeholder="Prénom" />
          </div>
          <div class="full">
            <label class="hint">Adresse</label>
            <input id="adresse" type="text" placeholder="Adresse" />
          </div>
          <textarea id="commentaires" placeholder="Commentaires / contexte…"></textarea>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" value="cancel">Annuler</button>
        <button class="btn primary" id="btnSave" value="default">Enregistrer</button>
      </div>
    </form>
  </dialog>

  <!-- Phone action modal -->
  <dialog id="dlgPhone">
    <form method="dialog" id="frmPhone">
      <div class="modal-head">
        <div style="font-weight:700">Contact appelé</div>
        <button class="btn ghost" value="cancel" aria-label="Fermer">✕</button>
      </div>
      <div class="modal-body">
        <p class="hint">Choisissez le statut après l'appel :</p>
        <div style="display:flex;gap:8px;">
          <button type="button" class="btn red" id="btnPhoneRed" title="ne prend pas">Ne prend pas</button>
          <button type="button" class="btn orange" id="btnPhoneOrange" title="n'a pas répondu, à rappeler">Pas répondu / Rappeler</button>
          <button type="button" class="btn green" id="btnPhoneGreen" title="prend un pack">Prend un pack</button>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" value="cancel">Annuler</button>
      </div>
    </form>
  </dialog>

<script>
  
  // Bouton pour ouvrir la modale Paramètres
document.getElementById('btnSettings')?.addEventListener('click', () => {
  // pré-remplir depuis le storage
  const api = document.getElementById('apiUrl');
  const sid = document.getElementById('sheetId');
  if (api) api.value = localStorage.getItem('crm_apiUrl') || '';
  if (sid) sid.value = localStorage.getItem('crm_sheetId') || '';
  document.getElementById('dlgSettings')?.showModal();
});

// Enregistrer depuis la modale (réutilise tes setters existants)
document.getElementById('frmSettings')?.addEventListener('submit', (e) => {
  e.preventDefault();
  const api = document.getElementById('apiUrl')?.value.trim() || '';
  const sid = document.getElementById('sheetId')?.value.trim() || '';
  localStorage.setItem('crm_apiUrl', api);
  localStorage.setItem('crm_sheetId', sid);
  // si tu as déjà des listeners change sur apiUrl/sheetId, ils ne se déclenchent pas ici;
  // donc on peut toaster et fermer :
  (typeof toast === 'function') && toast('Paramètres enregistrés');
  document.getElementById('dlgSettings')?.close();
});

document.addEventListener('DOMContentLoaded', () => {
  // ====== HELPERS ======
  const parseJSONSafe = (key, fallback) => {
    try {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    } catch { return fallback; }
  };

  // ====== CONFIG ======
  const settings = {
    get apiUrl(){ return localStorage.getItem('crm_apiUrl') || ''; },
    set apiUrl(v){ localStorage.setItem('crm_apiUrl', v||''); },
    get sheetId(){ return localStorage.getItem('crm_sheetId') || ''; },
    set sheetId(v){ localStorage.setItem('crm_sheetId', v||''); },
  };

  // ====== STATE ======
  /** @type {Array<Contact>} */
  let data = parseJSONSafe('crm_data', []);
  // Migration auto ancien schéma -> nouveau
  if (Array.isArray(data) && data.length && data[0] && ('nom' in data[0] || 'email' in data[0]) && !('societe' in data[0])) {
    data = data.map(o => ({
      id: o.id || ('L' + Math.random().toString(36).slice(2)),
      societe: '',
      magazine: '',
      dateRappel: o.relance || '',
      commentaires: o.notes || '',
      telephone: o.telephone || '',
      mail: o.email || '',
      nom: o.nom || '',
      prenom: o.prenom || '',
      poste: '',
      adresse: '',
      gsId: o.gsId || null
    }));
    localStorage.setItem('crm_data', JSON.stringify(data));
  }

  let dirty = new Set(parseJSONSafe('crm_dirty', []));
  let counter = Number(localStorage.getItem('crm_counter')||'1') || 1;

  // ====== FLAGS MAP (persist favoris/valide by societe) ======
  const FLAGS_KEY = 'crm_flags_by_societe';
  const normSocieteKey = (s) => String(s||'').trim().toLowerCase();
  function readFlagsMap(){
    try{ return JSON.parse(localStorage.getItem(FLAGS_KEY) || '{}'); }catch{return {};}
  }
  function writeFlagsMap(m){ localStorage.setItem(FLAGS_KEY, JSON.stringify(m||{})); }
  function setFlagForSociete(societe, patch){
    const k = normSocieteKey(societe); if(!k) return;
    const m = readFlagsMap(); m[k] = Object.assign({}, m[k]||{}, patch||{}); writeFlagsMap(m);
  }
  function getFlagsForSociete(societe){ const k = normSocieteKey(societe); if(!k) return null; const m = readFlagsMap(); return m[k] || null; }
  // applyFlagsToContact removed (not used). Flags are applied during import logic via setFlagForSociete/getFlagsForSociete.

  /** @typedef {{id:string, societe?:string, magazine?:string, dateRappel?:string, commentaires?:string, telephone?:string, mail?:string, nom?:string, prenom?:string, poste?:string, adresse?:string, gsId?:number}} Contact */

  // ====== DOM ======
  const els = {
    rows: document.getElementById('rows'),
    search: document.getElementById('search'),
    filtreValide: document.getElementById('filtreValide'),
    filtreMagazine: document.getElementById('filtreMagazine'),
    filtreRappel: document.getElementById('filtreRappel'),
    filtrePeriode: document.getElementById('filtrePeriode'),
    filtrePeriodeCustom: document.getElementById('filtrePeriodeCustom'),
    filtrePeriodeFrom: document.getElementById('filtrePeriodeFrom'),
    filtrePeriodeTo: document.getElementById('filtrePeriodeTo'),
    btnAdd: document.getElementById('btnAdd'),
    btnImport: document.getElementById('btnImport'),
    btnExport: document.getElementById('btnExport'),
    btnExportCsv: document.getElementById('btnExportCsv'),
    dlg: document.getElementById('dlg'),
    frm: document.getElementById('frm'),
    id: document.getElementById('id'),
    societe: document.getElementById('societe'),
    magazine: document.getElementById('magazine'), // <select>
    dateRappel: document.getElementById('dateRappel'),
    telephone: document.getElementById('telephone'),
    mail: document.getElementById('mail'),
    nom: document.getElementById('nom'),
    prenom: document.getElementById('prenom'),
    poste: document.getElementById('poste'),
    adresse: document.getElementById('adresse'),
    commentaires: document.getElementById('commentaires'),
    apiUrl: document.getElementById('apiUrl'),
    sheetId: document.getElementById('sheetId'),
    loading: document.getElementById('loading'),
    loadingMsg: document.getElementById('loadingMsg')
  };

  // ====== UTIL ======
  const saveLocal = () => {
    localStorage.setItem('crm_data', JSON.stringify(data));
    localStorage.setItem('crm_dirty', JSON.stringify([...dirty]));
    localStorage.setItem('crm_counter', String(counter));
  };

  const uid = () => 'L'+(counter++);
  // Convert ISO yyyy-mm-dd to a local Date at midnight to avoid timezone shifts
  function isoToLocalDate(iso){
    if(!iso) return null;
    const m = String(iso).trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(!m) return null;
    const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
    return new Date(y, mo, d);
  }
  // Flexible parser: returns a local Date (midnight) for multiple input shapes (ISO, dd/mm/yyyy, timestamps)
  function parseToLocalDate(v){
    if(!v) return null;
    if(v instanceof Date) return new Date(v.getFullYear(), v.getMonth(), v.getDate());
    const s = String(v).trim(); if(!s) return null;
    // ISO first
    const maybeIso = isoToLocalDate(s);
    if(maybeIso) return maybeIso;
    // Try parseDateToIso -> then convert
    try{
      const parsedIso = parseDateToIso(s);
      if(parsedIso) return isoToLocalDate(parsedIso);
    }catch(e){}
    // Fallback to Date parser
    const dt = new Date(s);
    if(!isNaN(dt)) return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    return null;
  }
  const fmtDate = d=> d ? (parseToLocalDate(d) ? parseToLocalDate(d).toLocaleDateString('fr-FR') : String(d)) : '';
  // helper: format a local Date as yyyy-mm-dd
  function formatLocalYmd(date){ if(!date) return ''; const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const dd=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
  const todayStr = formatLocalYmd(new Date());

  // Parse many possible date shapes (Sheets, Excel serials, timestamps, localized strings)
  // and return an ISO yyyy-mm-dd string or '' when unparseable.
  function parseDateToIso(v){
    if(v === null || v === undefined || v === '') return '';
    // If it's a numeric string (Excel serial or timestamp) treat as number
    if(typeof v === 'string' && /^\d+(?:\.\d+)?$/.test(v.trim())){
      return parseDateToIso(Number(v.trim()));
    }
    // helper -> produce yyyy-mm-dd from a Date instance using local components
    const localYmd = (date)=>{
      if(!date || isNaN(date)) return '';
      const y = date.getFullYear(); const m = String(date.getMonth()+1).padStart(2,'0'); const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    };
    // helper -> produce yyyy-mm-dd from a Date instance using UTC components
    const utcYmd = (date)=>{
      if(!date || isNaN(date)) return '';
      const y = date.getUTCFullYear(); const m = String(date.getUTCMonth()+1).padStart(2,'0'); const d = String(date.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    };

    // Numbers: could be ms since epoch, or Excel serial (days)
    if(typeof v === 'number'){
      // very large -> milliseconds since epoch
  if(v > 1000000000000) return utcYmd(new Date(Number(v)));
  // plausible ms timestamp
  if(v > 1000000000 && v < 1000000000000) return utcYmd(new Date(Number(v)));
      // else treat as Excel serial days (days since 1899-12-30) using local epoch
      try{
  const epoch = Date.UTC(1899,11,30); // Excel epoch in UTC
  const date = new Date(epoch + Math.round(v) * 24*3600*1000);
  if(!isNaN(date)) return utcYmd(date);
      }catch(e){}
      return '';
    }
  if(v instanceof Date) return isNaN(v)?'': utcYmd(v);

  

    let s = String(v).trim(); if(!s) return '';
    // If it contains time (e.g. "17/10/2025 00:00:00"), take the date portion first
    if(s.indexOf(' ')>0) s = s.split(' ')[0];
    if(s.indexOf('T')>0) s = s.split('T')[0];

    // ISO-like already (YYYY-MM-DD). Keep as-is but normalize to local YMD
    if(/^\d{4}-\d{2}-\d{2}/.test(s)){
      // create local date from parts to avoid timezone shenanigans
      const mm = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(mm){ const y=Number(mm[1]), mo=Number(mm[2])-1, d=Number(mm[3]); return localYmd(new Date(y,mo,d)); }
      return s.slice(0,10);
    }

    // common French dd/mm/yyyy or dd-mm-yyyy or dd.mm.yyyy (and variants with 2-digit year)
    const m = s.match(/^(\d{1,2})[\/\.\-](\d{1,2})[\/\.\-](\d{2,4})$/);
    if(m){
      let day = parseInt(m[1],10), month = parseInt(m[2],10), year = parseInt(m[3],10);
      if(year < 100) year += year > 30 ? 1900 : 2000;
      // prefer dd/mm interpretation (French). If month>12 it's clearly day/month swapped.
      // create as local date to avoid timezone shifts
  let dt = new Date(year, month-1, day);
      if(isNaN(dt) || dt.getFullYear() !== year){
        // try swapped (mm/dd)
        dt = new Date(year, day-1, month);
      }
  if(!isNaN(dt)) return localYmd(dt);
    }

    // Last resort: rely on Date parser
    const parsed = new Date(s);
    if(!isNaN(parsed)) return utcYmd(parsed);
    return '';
  }

  function setBusy(on, msg){
    if(!els.loading) return;
    els.loading.classList.toggle('show', !!on);
    els.loading.setAttribute('aria-hidden', on ? 'false' : 'true');
    if(els.loadingMsg) els.loadingMsg.textContent = msg ? msg : (on ? 'Chargement…' : '');
    [els.btnImport, els.btnExport, els.btnExportCsv, els.btnAdd].forEach(b=> b && (b.disabled = !!on));
  }

  function matchFilters(c){
    const q = (els.search?.value || '').trim().toLowerCase();
    const fm = els.filtreMagazine?.value || '';
    const fr = els.filtreRappel?.value || '';
    const fp = els.filtrePeriode?.value || '';
    const fv = els.filtreValide?.value || ''; 
    let ok = true;
    if(q){
      if(q.startsWith('tel:')) ok = (c.telephone||'').replace(/\s+/g,'') === q.slice(4);
      else ok = [c.societe,c.magazine,c.nom,c.prenom,c.telephone,c.mail,c.adresse,c.commentaires,c.poste]
        .some(v=> (v||'').toLowerCase().includes(q));
    }
    if(ok && fm) ok = (c.magazine||'')===fm;
    if(ok && fv){
      if(fv === 'valide') {
        ok = !!c.valide;
      } else if(fv === 'important') {
        // "à rappeler": show contacts marked for callback OR general favoris
        ok = !c.valide && ((c._favorisState === 'call') || !!c.favoris);
      } else if(fv === 'favoris') {
        // "Ne prend pas": show contacts explicitly marked as "no" after call
        ok = (c._favorisState === 'no');
      }
    }
    if(ok && fr){
    const r = c.dateRappel || '';
    const date = r ? parseToLocalDate(r) : null;
    const todayLocal = parseToLocalDate(todayStr);
  const now = new Date();
  const weekEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (7 - now.getDay()));
  if(fr==='aucune') ok = !r;
  else if(fr==='en_retard') ok = r && date && (date.getTime() < todayLocal.getTime());
  else if(fr==='a_venir') ok = r && date && (date.getTime() > todayLocal.getTime());
  else if(fr==='aujourdhui') ok = r && date && (date.getTime() === todayLocal.getTime());
  else if(fr==='cette_semaine') ok = r && date && (date.getTime() >= todayLocal.getTime() && date.getTime() <= weekEnd.getTime());
    }
    // Period filter (footer): current month or current year based on dateRappel
    if(ok && fp){
      const r = c.dateRappel || '';
      const d = r ? parseToLocalDate(r) : null;
      if(!d) return false;
      const today = parseToLocalDate(todayStr);
      if(fp === 'mois'){
        ok = (d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth());
      } else if(fp === 'annee'){
        ok = (d.getFullYear() === today.getFullYear());
      } else if(fp === 'custom'){
        try{
          const fromRaw = els.filtrePeriodeFrom?.value || '';
          const toRaw = els.filtrePeriodeTo?.value || '';
          const from = fromRaw ? parseToLocalDate(fromRaw) : null;
          const to = toRaw ? parseToLocalDate(toRaw) : null;
          if(!from && !to){
            ok = true;
          } else {
            let inRange = true;
            if(from) inRange = inRange && (d.getTime() >= from.getTime());
            if(to) inRange = inRange && (d.getTime() <= to.getTime());
            ok = inRange;
          }
        }catch(e){ ok = false; }
      }
    }
    return ok;
  }

  function render(){
    if(!els.rows) return;
    els.rows.innerHTML = '';
    const frag = document.createDocumentFragment();
    // Ensure favorites are rendered first
    const rowsToRender = data.slice().sort((a,b)=>{
      const af = a.favoris?1:0; const bf = b.favoris?1:0;
      if(af!==bf) return bf-af; // favoris first
      return 0;
    }).filter(matchFilters);

    rowsToRender.forEach(c=>{
  const tr = document.createElement('tr');
  const classes = ['row'];
  if (c.favoris) classes.push('favoris');
  if (c.valide) classes.push('valide');
  if (c._favorisState === 'no') classes.push('favoris-no');
  if (c._favorisState === 'call') classes.push('favoris-call');
  tr.className = classes.join(' ');
      // phone button style depends on contact status
      let phoneClass = 'btn';
      let phoneTitle = 'Appeler';
      if (c.valide) { phoneClass = 'btn green'; phoneTitle = 'Contact validé (pack vendu)'; }
      else if (c._favorisState === 'call') { phoneClass = 'btn orange'; phoneTitle = 'À rappeler'; }
      else if (c._favorisState === 'no') { phoneClass = 'btn red'; phoneTitle = 'Refus / Ne prend pas'; }

      tr.innerHTML = `
        <td class="actions">
          ${dirty.has(c.id)?'<span class="hint">•</span>':''}
          <button class="btn" data-edit="${c.id}" title="Modifier">✎</button>
          <button class="${phoneClass}" data-phone="${c.id}" title="${phoneTitle}">✆</button>
        </td>
        <td>${c.societe||''}</td>
        <td>${c.magazine||''}</td>
        <td>${c.dateRappel?fmtDate(c.dateRappel):'<span class="muted">—</span>'}</td>
        <td>${c.commentaires?String(c.commentaires).replace(/</g,'&lt;'):''}</td>
        <td>${c.telephone?`<a class="link" href="tel:${c.telephone}">${c.telephone}</a>`:''}</td>
        <td>${c.mail?`<a class="link" href="mailto:${c.mail}">${c.mail}</a>`:''}</td>
        <td>${c.nom||''}</td>
        <td>${c.prenom||''}</td>
        <td>${c.poste||''}</td>
        <td>${c.adresse||''}</td>
        `;
      frag.appendChild(tr);
    });
    els.rows.appendChild(frag);
    updateFooterCounts(rowsToRender);
  }

  // Footer counts: total appels (sum of no/call/pack), refus (no), a rappeler (call), packs vendus (valide)
  function updateFooterCounts(rows){
    const set = Array.isArray(rows) ? rows : data;
    const total = set.reduce((acc,c)=> acc + ((c._favorisState==='no' || c._favorisState==='call' || c.valide)?1:0), 0);
    const refus = set.reduce((acc,c)=> acc + (c._favorisState==='no'?1:0), 0);
    const rappel = set.reduce((acc,c)=> acc + (c._favorisState==='call'?1:0), 0);
    const packs = set.reduce((acc,c)=> acc + (c.valide?1:0), 0);
    const elTotal = document.getElementById('cntTotal'); if(elTotal) elTotal.textContent = String(total);
    const elRefus = document.getElementById('cntRefus'); if(elRefus) elRefus.textContent = String(refus);
    const elRappel = document.getElementById('cntRappel'); if(elRappel) elRappel.textContent = String(rappel);
    const elPacks = document.getElementById('cntPacks'); if(elPacks) elPacks.textContent = String(packs);
  }

  // ====== CRUD (local) ======
  function upsertLocal(c){
    const i = data.findIndex(x=>x.id===c.id);
    if(i>=0) data[i]=c; else data.unshift(c);
    dirty.add(c.id);
    saveLocal();
    render();
  }
  function removeLocal(id){
    data = data.filter(x=>x.id!==id);
    dirty.delete(id);
    saveLocal();
    render();
  }
  function favorisLocal(id){
    const i = data.findIndex(x=>x.id===id);
    if(i<0) return;
    const c = data[i];
    // toggle
    c.favoris = !c.favoris;
    // if now favori, move to top
    if(c.favoris){
      data.splice(i,1);
      data.unshift(c);
    }
    // mark modified so export will pick up this change
    dirty.add(c.id);
    saveLocal();
    render();
  }
  function validateLocal(id){
    const c = data.find(x=>x.id===id);
    if(!c) return;
    // toggle validation
    c.valide = !c.valide;
    if (c.valide) {
      // when validated, clear 'to recall' state so it won't appear in rappel
      c._favorisState = 'none';
    }
    // mark modified so export will pick up this change
    dirty.add(c.id);
    saveLocal();
    render();
  }

  // ====== MAGAZINE (select uniquement, accepte texte depuis Sheets) ======
  function ensureMagazineOption(value) {
    if (!els.magazine) return;
    const v = (value ?? '').toString();
    // si vide, ne rien ajouter
    if (!v) return;
    // si l'option existe déjà, on ne fait rien
    for (const opt of els.magazine.options) {
      if (opt.value === v) return;
    }
    // sinon on l'ajoute dynamiquement
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    opt.dataset.dynamic = '1';
    els.magazine.appendChild(opt);
  }

  function setMagazineValue(value) {
    if (!els.magazine) return;
    const v = (value ?? '').toString();
    ensureMagazineOption(v);
    els.magazine.value = v; // si v n'existait pas, il existe désormais
  }

  function getMagazineValue() {
    const v = els.magazine?.value || '';
    return v === '-' ? '' : v; // si tu utilises une option "-" pour vider la valeur
  }

  // ====== MODAL ======
  function openModal(c){
    document.getElementById('dlgTitle').textContent = c? 'Modifier contact' : 'Nouveau contact';
    els.id.value = c?.id || '';
    els.societe.value = c?.societe || '';
    setMagazineValue(c?.magazine || '');
    els.dateRappel.value = c?.dateRappel || '';
    els.telephone.value = c?.telephone || '';
    els.mail.value = c?.mail || '';
    els.nom.value = c?.nom || '';
    els.prenom.value = c?.prenom || '';
    els.poste.value = c?.poste || '';
    els.adresse.value = c?.adresse || '';
    els.commentaires.value = c?.commentaires || '';
    els.dlg.showModal();
  }

  // ====== SHEETS SYNC (CORS-safe) ======
  function apiEnabled(){ return !!settings.apiUrl; }
  async function apiFetch(params={}, method='GET'){
    if(!apiEnabled()) throw new Error('Aucune URL API configurée.');
    const base = settings.apiUrl;
    if(method === 'GET'){
      const url = new URL(base);
      Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,String(v)));
      const res = await fetch(url.toString(), { method:'GET', credentials:'omit' });
      if(!res.ok) throw new Error('Erreur API '+res.status);
      return res.json();
    }else{
      const body = new URLSearchParams();
      for(const [k,v] of Object.entries(params)){
        body.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
      }
      const res = await fetch(base, { method:'POST', body, credentials:'omit' });
      if(!res.ok) throw new Error('Erreur API '+res.status);
      return res.json();
    }
  }

  function normalizeContactFromApi(row){
    const norm = {};
    for(const [k,v] of Object.entries(row||{})){
      const kk = String(k).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
      norm[kk] = v;
    }
    // try to find any key that looks like a 'rappel' / reminder date (handles "Date de rappel" headers etc.)
    const dateKey = Object.keys(norm).find(k => k.includes('rappel')) || Object.keys(norm).find(k => k.includes('date'));
    const rawDate = dateKey ? norm[dateKey] : (norm.daterappel || norm.rappel || row?.dateRappel || row?.rappel || '');
    // normalize imported date to ISO yyyy-mm-dd when possible
    // then force +1 day to avoid timezone/day-shift issues as requested
    const _parsed = parseDateToIso(rawDate);
    let _finalDate = '';
    if(_parsed){
      const _d = isoToLocalDate(_parsed);
      if(_d){
        _d.setDate(_d.getDate());
        _finalDate = formatLocalYmd(_d);
      }
    }
    return {
      gsId: Number(norm.gsid ?? row.gsId ?? 0) || null,
      societe: norm.societe || norm.entreprise || '',
      magazine: norm.magazine || '',
      dateRappel: _finalDate,
      commentaires: norm.commentaires || norm.notes || '',
      telephone: (norm.telephone ?? '').toString(),
      mail: norm.mail || norm.email || '',
      nom: norm.nom || '',
      prenom: norm.prenom || '',
      poste: norm.poste || '',
      adresse: norm.adresse || ''
    };
  }

  async function importFromSheets(){
    setBusy(true, 'Chargement depuis Sheets…');
    try{
      const out = await apiFetch({ action:'list' }, 'GET');
      // preserve previous local statuses by attempting to match incoming rows
      const oldData = data.slice();
      data = out.rows.map(r => {
        const c = normalizeContactFromApi(r);
        // debug logs removed
        const newId = 'G' + (c.gsId ?? uid().slice(1));
        // find best local match
        const cleanPhone = s => String(s||'').replace(/\D+/g,'');
        const existing = oldData.find(x => {
          try{
            if(x.gsId && c.gsId && Number(x.gsId) === Number(c.gsId)) return true;
            const ks = normSocieteKey(x.societe || '');
            const kc = normSocieteKey(c.societe || '');
            if(ks && kc && ks === kc) return true;
            if(cleanPhone(x.telephone) && cleanPhone(c.telephone) && cleanPhone(x.telephone) === cleanPhone(c.telephone)) return true;
            if(x.mail && c.mail && String(x.mail).toLowerCase() === String(c.mail).toLowerCase()) return true;
            if(x.nom && c.nom && x.prenom && c.prenom && String(x.nom).toLowerCase() === String(c.nom).toLowerCase() && String(x.prenom).toLowerCase() === String(c.prenom).toLowerCase()) return true;
          }catch(e){/* ignore */}
          return false;
        });
        if(existing){
          c.favoris = !!existing.favoris;
          c.valide = !!existing.valide;
          c._favorisState = existing._favorisState || 'none';
          // ensure flags map reflects preserved state
          try{ setFlagForSociete(c.societe, { favoris: !!c.favoris, valide: !!c.valide }); }catch(e){}
        } else {
          c.favoris = !!c.favoris;
          c.valide = !!c.valide;
          c._favorisState = c._favorisState || 'none';
        }
        return Object.assign({ id: newId }, c);
      });
      dirty = new Set();
      saveLocal(); render();
      toast('Import terminé');
    }catch(e){
      alert('Import impossible: '+e.message);
    } finally { setBusy(false); }
  }

  function contactToApiRow(c){
    return {
      gsId: c.gsId || null,
      societe: c.societe || '', 'SOCIETE': c.societe || '',
      magazine: c.magazine || '', 'Magazine': c.magazine || '', // en-tête côté Sheets
      dateRappel: c.dateRappel || '', 'DATE DE RAPPPEL': c.dateRappel || '', // compat
      commentaires: c.commentaires || '', 'COMMENTAIRES': c.commentaires || '',
      telephone: String(c.telephone || ''), 'TELEPHONE': String(c.telephone || ''),
      mail: c.mail || '', 'MAIL': c.mail || '',
      nom: c.nom || '', 'NOM': c.nom || '',
      prenom: c.prenom || '', 'PRENOM': c.prenom || '',
      poste: c.poste || '', 'POSTE': c.poste || '',
      adresse: c.adresse || '', 'ADRESSE': c.adresse || ''
    };
  }

  async function exportDirty(){
    if(!apiEnabled()) return alert("Ajoutez l'URL de votre Web App.");
    const toSend = data.filter(c => dirty.has(c.id));
    if(!toSend.length) return toast('Rien à synchroniser');

    const oldIds = toSend.map(c => c.id);
    setBusy(true, 'Synchronisation en cours…');
    try{
      const payload = toSend.map(contactToApiRow);
      const out = await apiFetch({ action:'bulkUpsert', rows: payload }, 'POST');
      out.results.forEach((r,i)=>{
        const local = toSend[i];
        local.gsId = r.gsId;
        local.id = 'G' + r.gsId;
      });
      oldIds.forEach(id => dirty.delete(id));
      saveLocal(); render(); toast('Synchronisation réussie');
    }catch(e){
      alert('Export impossible: ' + e.message);
    } finally { setBusy(false); }
  }

  async function deleteInSheets(gsId){
    if(!apiEnabled() || !gsId) return;
    try{
      setBusy(true, 'Suppression…');
      await apiFetch({ action:'delete', id: String(gsId) }, 'POST');
    }catch(e){
      console.warn('Suppression distante échouée', e);
    } finally { setBusy(false); }
  }

  // ====== EXPORT CSV ======
  function exportCsv(){
    const cols = ['societe','magazine','dateRappel','commentaires','telephone','mail','nom','prenom','poste','adresse','statut'];
    // Build CSV lines from currently visible rows (matchFilters) so export matches the table view
    const visible = data.filter(matchFilters);
    const lines = [cols.join(',')].concat(
      visible.map(c=> {
        const statut = c.valide ? 'pack vendu' : (c._favorisState === 'call' ? 'à rappeler' : (c._favorisState === 'no' ? 'ne prend pas' : ''));
        const row = Object.assign({}, c, { statut });
        return cols.map(k=> '"'+String(row[k]||'').replace(/"/g,'""')+'"').join(',');
      })
    );

    // Summary counts (based on the same visible set)
    try{
      const today = parseToLocalDate(todayStr);
      const callsThisMonth = visible.reduce((acc,c)=>{
        const d = c.dateRappel ? parseToLocalDate(c.dateRappel) : null;
        if(!d) return acc;
        const isThisMonth = d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth();
        const isCall = (c._favorisState==='no' || c._favorisState==='call' || !!c.valide);
        return acc + (isThisMonth && isCall ? 1 : 0);
      },0);
      const callsThisYear = visible.reduce((acc,c)=>{
        const d = c.dateRappel ? parseToLocalDate(c.dateRappel) : null;
        if(!d) return acc;
        const isThisYear = d.getFullYear()===today.getFullYear();
        const isCall = (c._favorisState==='no' || c._favorisState==='call' || !!c.valide);
        return acc + (isThisYear && isCall ? 1 : 0);
      },0);
      const countRappel = visible.reduce((acc,c)=> acc + (c._favorisState==='call'?1:0), 0);
      const countRefus = visible.reduce((acc,c)=> acc + (c._favorisState==='no'?1:0), 0);
      const countPacks = visible.reduce((acc,c)=> acc + (c.valide?1:0), 0);

      // Append a single summary row at the end
      const summary = {
        societe: 'Résumé',
        magazine: '',
        dateRappel: '',
        commentaires: `appels_mois:${callsThisMonth}; appels_annee:${callsThisYear}`,
        telephone: '',
        mail: '',
        nom: '',
        prenom: '',
        poste: '',
        adresse: '',
        statut: `a_rappeler:${countRappel}; refus:${countRefus}; vendus:${countPacks}`
      };
      lines.push(cols.map(k=> '"'+String(summary[k]||'').replace(/"/g,'""')+'"').join(','));
    }catch(e){ /* ignore summary if something fails */ }
    const blob = new Blob(["\uFEFF"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'contacts.csv'; a.click();
  }

  // ====== TOAST ======
  let toastTimer; function toast(msg){
    clearTimeout(toastTimer);
    let t = document.getElementById('toast');
    if(!t){ t=document.createElement('div'); t.id='toast'; t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b1220;border:1px solid #334155;color:#e5e7eb;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:9999'; document.body.appendChild(t); }
    t.textContent = msg; t.style.opacity='1';
    toastTimer=setTimeout(()=>{t.style.opacity='0'}, 2200);
  }

  // ====== EVENTS ======
  els.search?.addEventListener('input', render);
  els.filtreMagazine?.addEventListener('change', render);
  els.filtreValide?.addEventListener('change', render);
  els.filtreRappel?.addEventListener('change', render);
  els.filtrePeriode?.addEventListener('change', render);
  // show/hide custom period inputs
  els.filtrePeriode?.addEventListener('change', (e)=>{
    try{
      const v = e.target.value;
      if(els.filtrePeriodeCustom) els.filtrePeriodeCustom.style.display = (v==='custom') ? 'flex' : 'none';
      localStorage.setItem('crm_filtrePeriode', v || '');
      render();
    }catch(e){}
  });
  // persist custom dates
  els.filtrePeriodeFrom?.addEventListener('change', (e)=>{ localStorage.setItem('crm_filtrePeriodeFrom', e.target.value || ''); render(); });
  els.filtrePeriodeTo?.addEventListener('change', (e)=>{ localStorage.setItem('crm_filtrePeriodeTo', e.target.value || ''); render(); });
  els.btnAdd?.addEventListener('click', ()=> openModal(null));
  // When importing from the settings modal, close the modal first so the loader is visible,
  // then start the import (importFromSheets manages the busy/loader state itself).
  els.btnImport?.addEventListener('click', (e)=>{
    try{ document.getElementById('dlgSettings')?.close(); }catch(e){}
    // small timeout lets the dialog close animation settle and loader appear smoothly
    setTimeout(()=> importFromSheets(), 80);
  });
  els.btnExport?.addEventListener('click', exportDirty);
  els.btnExportCsv?.addEventListener('click', exportCsv);

  if (els.apiUrl) els.apiUrl.value = settings.apiUrl;
  if (els.sheetId) els.sheetId.value = settings.sheetId;
  els.apiUrl?.addEventListener('change', e=>{ settings.apiUrl = e.target.value.trim(); toast('URL API enregistrée'); });
  els.sheetId?.addEventListener('change', e=>{ settings.sheetId = e.target.value.trim(); toast('Sheet ID enregistré'); });

  // Restore/save period filter selection so user preference persists
  try{
    if(els.filtrePeriode){
      const saved = localStorage.getItem('crm_filtrePeriode') || '';
      els.filtrePeriode.value = saved;
      // show custom inputs if needed
      if(els.filtrePeriodeCustom) els.filtrePeriodeCustom.style.display = (saved==='custom') ? 'flex' : 'none';
      // restore custom dates
      if(els.filtrePeriodeFrom) els.filtrePeriodeFrom.value = localStorage.getItem('crm_filtrePeriodeFrom') || '';
      if(els.filtrePeriodeTo) els.filtrePeriodeTo.value = localStorage.getItem('crm_filtrePeriodeTo') || '';
    }
  }catch(e){}

  els.rows?.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    // phone button
    if (b.dataset.phone) {
      const id = b.dataset.phone;
      // store current target
      window._phoneTargetId = id;
      document.getElementById('dlgPhone')?.showModal();
      return;
    }
    const id = b.dataset.edit || b.dataset.del || b.dataset.favoris || b.dataset.validate; if(!id) return;
    const c = data.find(x=>x.id===id);
    if(b.dataset.edit){ openModal(c); }
    if(b.dataset.del){ if(confirm('Supprimer ce contact ?')){ removeLocal(id); deleteInSheets(c?.gsId); }}
    if(b.dataset.favoris){ favorisLocal(id); toast('Contact marqué comme favori'); }
    if(b.dataset.validate){ validateLocal(id); toast('Bravo pack vendu !'); }
  });

  // Phone dialog actions
  const dlgPhone = document.getElementById('dlgPhone');
  const btnPhoneRed = document.getElementById('btnPhoneRed');
  const btnPhoneOrange = document.getElementById('btnPhoneOrange');
  const btnPhoneGreen = document.getElementById('btnPhoneGreen');

  function applyPhoneAction(id, action){
    const c = data.find(x=>x.id===id); if(!c) return;
    // reset previous favoris markers for that contact
    // we store visual state in properties: favorisState = 'none'|'call'|'no'
    if(!c._favorisState) c._favorisState = 'none';
    if(action === 'red'){
      // mark red: not taking -> visual red
      c._favorisState = 'no';
      // set rappel date to today so it's visible in the table
      c.dateRappel = todayStr;
      // record timestamp for the phone state
      c._favorisStateDate = new Date().toISOString();
      // If previously validated, remove that status (only one status allowed)
      if(c.valide){ c.valide = false; c.valideDate = null; }
      c.favoris = false;
      // update flags: not favoris, not valide
      setFlagForSociete(c.societe, { favoris: false, valide: false });
      // add a CSS class on the row via render logic (we'll re-render)
      toast('Ne prend pas pour cette période');
    } else if(action === 'orange'){
      // mark orange: to recall -> favoris orange and move to top
      c._favorisState = 'call';
      // set the rappel date to today so it's scheduled/visible
      c.dateRappel = todayStr;
  // If previously validated, remove that status (only one status allowed)
  if(c.valide){ c.valide = false; c.valideDate = null; }
  // Ensure this contact is NOT marked as favoris so it won't be sorted to top
  c.favoris = false;
  // update flags: remove favoris and ensure 'valide' is false for this societe
  setFlagForSociete(c.societe, { favoris: false, valide: false });
      // don't reorder the list; user can rely on filters instead
      toast("à rappeler");
    } else if(action === 'green'){
      // mark green: takes a pack -> validated
      c._favorisState = 'none';
      // set rappel date to today to mark when it was sold
      c.dateRappel = todayStr;
      // Remove any call-state (exclusive)
      c._favorisStateDate = null;
      c.favoris = false;
      c.valide = true;
      // record validation date
      c.valideDate = new Date().toISOString();
      // update flags: valide true, favoris false
      setFlagForSociete(c.societe, { valide: true, favoris: false });
      toast('Bravo pack vendu !');
    }
    // mark modified so export will pick up this change
    dirty.add(c.id);
    // persist and re-render
    saveLocal(); render();
  }

  btnPhoneRed?.addEventListener('click', ()=>{
    const id = window._phoneTargetId; if(!id) return; applyPhoneAction(id, 'red'); dlgPhone.close();
  });
  btnPhoneOrange?.addEventListener('click', ()=>{
    const id = window._phoneTargetId; if(!id) return; applyPhoneAction(id, 'orange'); dlgPhone.close();
  });
  btnPhoneGreen?.addEventListener('click', ()=>{
    const id = window._phoneTargetId; if(!id) return; applyPhoneAction(id, 'green'); dlgPhone.close();
  });

  // Removed old DOM-only favorit sorting; logic handled in render() and favorisLocal().

  els.frm?.addEventListener('submit', (e)=>{
    if (e.submitter && e.submitter.value === 'cancel') {
      return; // pas de preventDefault => <form method="dialog"> ferme la modale
    }
    e.preventDefault();
    const c = {
      id: els.id.value || uid(),
      societe: els.societe.value.trim(),
      magazine: getMagazineValue(),          // <-- valeur du select (ou vide si "-")
      dateRappel: els.dateRappel.value,
      telephone: els.telephone.value.trim(),
      mail: els.mail.value.trim(),
      nom: els.nom.value.trim(),
      prenom: els.prenom.value.trim(),
      poste: els.poste.value.trim(),
      adresse: els.adresse.value.trim(),
      commentaires: els.commentaires.value.trim(),
      gsId: data.find(x=>x.id===els.id.value)?.gsId || null
    };
    // Preserve status fields when editing an existing contact
    const existing = data.find(x=>x.id===c.id);
    if(existing){
      c.favoris = !!existing.favoris;
      c.valide = !!existing.valide;
      c._favorisState = existing._favorisState || 'none';
    } else {
      // defaults for new contacts
      c.favoris = false;
      c.valide = false;
      c._favorisState = 'none';
    }
    if(!c.societe && !c.nom) return alert('Renseignez au moins Société ou Nom.');
    upsertLocal(c);
    els.dlg.close();
  });

  // ====== INIT ======
  render();
});
</script>

</body>
</html>
